apiVersion: v1
kind: Namespace
metadata:
  name: coretex
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coretex-pools
  namespace: coretex
data:
  pools.yaml: |
    topics:
      job.echo: echo
      job.chat.simple: chat-simple
      job.chat.advanced: chat-advanced
      job.code.llm: code-llm
      job.workflow.plan: workflow-planner
      job.workflow.demo: workflow-demo
      job.workflow.repo.code_review: workflow-repo
      job.repo.scan: repo-scan
      job.repo.partition: repo-partition
      job.repo.lint: repo-lint
      job.repo.sast: repo-sast
      job.repo.tests: repo-tests
      job.repo.report: repo-report
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coretex-timeouts
  namespace: coretex
data:
  timeouts.yaml: |
    workflows:
      code_review_demo:
        child_timeout_seconds: 1200
        total_timeout_seconds: 1800
        max_retries: 1
      repo_code_review:
        child_timeout_seconds: 1200
        total_timeout_seconds: 1800
        max_retries: 1
    topics:
      job.code.llm:
        timeout_seconds: 1200
        max_retries: 0
      job.chat.simple:
        timeout_seconds: 60
        max_retries: 0
      job.repo.scan:
        timeout_seconds: 300
        max_retries: 0
      job.repo.partition:
        timeout_seconds: 120
        max_retries: 0
      job.repo.lint:
        timeout_seconds: 240
        max_retries: 0
      job.repo.sast:
        timeout_seconds: 240
        max_retries: 0
      job.repo.tests:
        timeout_seconds: 600
        max_retries: 0
      job.repo.report:
        timeout_seconds: 180
        max_retries: 0
    reconciler:
      dispatch_timeout_seconds: 120
      running_timeout_seconds: 1500
      scan_interval_seconds: 30
---
apiVersion: v1
kind: Secret
metadata:
  name: coretex-api-key
  namespace: coretex
type: Opaque
stringData:
  API_KEY: super-secret-key
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nats
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: nats}
  template:
    metadata:
      labels: {app: nats}
    spec:
      containers:
      - name: nats
        image: nats:2.10
        args: ["-js"]
        ports:
        - name: client
          containerPort: 4222
        livenessProbe:
          tcpSocket: {port: 4222}
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: nats
  namespace: coretex
spec:
  selector: {app: nats}
  ports:
  - name: client
    port: 4222
    targetPort: 4222
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: redis}
  template:
    metadata:
      labels: {app: redis}
    spec:
      containers:
      - name: redis
        image: redis:7
        ports:
        - containerPort: 6379
        livenessProbe:
          tcpSocket: {port: 6379}
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: coretex
spec:
  selector: {app: redis}
  ports:
  - port: 6379
    targetPort: 6379
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coretex-context-engine
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: coretex-context-engine}
  template:
    metadata:
      labels: {app: coretex-context-engine}
    spec:
      containers:
      - name: context-engine
        image: coretex-coretex-context-engine
        env:
        - name: REDIS_URL
          value: redis://redis:6379
        - name: CONTEXT_ENGINE_ADDR
          value: ":50070"
        ports:
        - containerPort: 50070
        livenessProbe:
          tcpSocket: {port: 50070}
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: coretex-context-engine
  namespace: coretex
spec:
  selector: {app: coretex-context-engine}
  ports:
  - port: 50070
    targetPort: 50070
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coretex-safety-kernel
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: coretex-safety-kernel}
  template:
    metadata:
      labels: {app: coretex-safety-kernel}
    spec:
      containers:
      - name: safety
        image: coretex-coretex-safety-kernel
        env:
        - name: SAFETY_KERNEL_ADDR
          value: ":50051"
        ports:
        - containerPort: 50051
        livenessProbe:
          tcpSocket: {port: 50051}
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: coretex-safety-kernel
  namespace: coretex
spec:
  selector: {app: coretex-safety-kernel}
  ports:
  - port: 50051
    targetPort: 50051
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coretex-scheduler
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: coretex-scheduler}
  template:
    metadata:
      labels: {app: coretex-scheduler}
    spec:
      containers:
      - name: scheduler
        image: coretex-coretex-scheduler
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: REDIS_URL
          value: redis://redis:6379
        - name: SAFETY_KERNEL_ADDR
          value: coretex-safety-kernel:50051
        - name: POOL_CONFIG_PATH
          value: /etc/coretex/pools.yaml
        - name: TIMEOUT_CONFIG_PATH
          value: /etc/coretex/timeouts.yaml
        - name: JOB_META_TTL
          value: "168h"
        volumeMounts:
        - name: pools
          mountPath: /etc/coretex/pools.yaml
          subPath: pools.yaml
        - name: timeouts
          mountPath: /etc/coretex/timeouts.yaml
          subPath: timeouts.yaml
        ports:
        - containerPort: 9090
        livenessProbe:
          tcpSocket: {port: 9090}
          initialDelaySeconds: 5
          periodSeconds: 10
      volumes:
      - name: pools
        configMap:
          name: coretex-pools
          items:
          - key: pools.yaml
            path: pools.yaml
      - name: timeouts
        configMap:
          name: coretex-timeouts
          items:
          - key: timeouts.yaml
            path: timeouts.yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coretex-api-gateway
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: coretex-api-gateway}
  template:
    metadata:
      labels: {app: coretex-api-gateway}
    spec:
      containers:
      - name: gateway
        image: coretex-coretex-api-gateway
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: REDIS_URL
          value: redis://redis:6379
        - name: SAFETY_KERNEL_ADDR
          value: coretex-safety-kernel:50051
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: coretex-api-key
              key: API_KEY
        - name: CORETEX_API_KEY
          valueFrom:
            secretKeyRef:
              name: coretex-api-key
              key: API_KEY
        - name: CORETEX_SUPER_SECRET_API_TOKEN
          valueFrom:
            secretKeyRef:
              name: coretex-api-key
              key: API_KEY
        - name: TENANT_ID
          value: "default"
        - name: API_RATE_LIMIT_RPS
          value: "50"
        - name: API_RATE_LIMIT_BURST
          value: "100"
        - name: REDIS_DATA_TTL
          value: "24h"
        - name: JOB_META_TTL
          value: "168h"
        ports:
        - containerPort: 8080
        - containerPort: 8081
        - containerPort: 9092
        livenessProbe:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: coretex-api-gateway
  namespace: coretex
spec:
  selector: {app: coretex-api-gateway}
  ports:
  - name: http
    port: 8081
    targetPort: 8081
  - name: grpc
    port: 8080
    targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coretex-workflow-engine
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: coretex-workflow-engine}
  template:
    metadata:
      labels: {app: coretex-workflow-engine}
    spec:
      containers:
      - name: workflow-engine
        image: coretex-coretex-workflow-engine
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: REDIS_URL
          value: redis://redis:6379
        - name: WORKFLOW_ENGINE_HTTP_ADDR
          value: ":9093"
        - name: WORKFLOW_ENGINE_SCAN_INTERVAL
          value: "5s"
        - name: WORKFLOW_ENGINE_RUN_SCAN_LIMIT
          value: "200"
        ports:
        - containerPort: 9093
        livenessProbe:
          httpGet:
            path: /health
            port: 9093
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: coretex-workflow-engine
  namespace: coretex
spec:
  selector: {app: coretex-workflow-engine}
  ports:
  - port: 9093
    targetPort: 9093
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coretex-worker-echo
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: coretex-worker-echo}
  template:
    metadata:
      labels: {app: coretex-worker-echo}
    spec:
      containers:
      - name: worker
        image: coretex-coretex-worker-echo
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: REDIS_URL
          value: redis://redis:6379
        - name: REDIS_DATA_TTL
          value: "24h"
        ports:
        - containerPort: 8082
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coretex-worker-chat
  namespace: coretex
spec:
  replicas: 2
  selector:
    matchLabels: {app: coretex-worker-chat}
  template:
    metadata:
      labels: {app: coretex-worker-chat}
    spec:
      containers:
      - name: worker
        image: coretex-coretex-worker-chat
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: REDIS_URL
          value: redis://redis:6379
        - name: REDIS_DATA_TTL
          value: "24h"
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: coretex-worker-chat-hpa
  namespace: coretex
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: coretex-worker-chat
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coretex-worker-chat-advanced
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: coretex-worker-chat-advanced}
  template:
    metadata:
      labels: {app: coretex-worker-chat-advanced}
    spec:
      containers:
      - name: worker
        image: coretex-coretex-worker-chat-advanced
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: REDIS_URL
          value: redis://redis:6379
        - name: CONTEXT_ENGINE_ADDR
          value: coretex-context-engine:50070
        - name: OLLAMA_URL
          value: http://ollama:11434
        - name: REDIS_DATA_TTL
          value: "24h"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coretex-worker-code-llm
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: coretex-worker-code-llm}
  template:
    metadata:
      labels: {app: coretex-worker-code-llm}
    spec:
      containers:
      - name: worker
        image: coretex-coretex-worker-code-llm
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: REDIS_URL
          value: redis://redis:6379
        - name: CONTEXT_ENGINE_ADDR
          value: coretex-context-engine:50070
        - name: OLLAMA_URL
          value: http://ollama:11434
        - name: REDIS_DATA_TTL
          value: "24h"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coretex-worker-orchestrator
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: coretex-worker-orchestrator}
  template:
    metadata:
      labels: {app: coretex-worker-orchestrator}
    spec:
      containers:
      - name: worker
        image: coretex-coretex-worker-orchestrator
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: REDIS_URL
          value: redis://redis:6379
        - name: TIMEOUT_CONFIG_PATH
          value: /etc/coretex/timeouts.yaml
        - name: REDIS_DATA_TTL
          value: "24h"
        - name: USE_PLANNER
          value: "false"
        - name: PLANNER_TOPIC
          value: job.workflow.plan
        volumeMounts:
        - name: timeouts
          mountPath: /etc/coretex/timeouts.yaml
          subPath: timeouts.yaml
      volumes:
      - name: timeouts
        configMap:
          name: coretex-timeouts
          items:
          - key: timeouts.yaml
            path: timeouts.yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: coretex-worker-planner
  namespace: coretex
spec:
  replicas: 1
  selector:
    matchLabels: {app: coretex-worker-planner}
  template:
    metadata:
      labels: {app: coretex-worker-planner}
    spec:
      containers:
      - name: worker
        image: coretex-coretex-worker-planner
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: REDIS_URL
          value: redis://redis:6379
        - name: REDIS_DATA_TTL
          value: "24h"
