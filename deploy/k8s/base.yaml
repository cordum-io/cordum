apiVersion: v1
kind: Namespace
metadata:
  name: cordum
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cordum-pools
  namespace: cordum
data:
  pools.yaml: |
    topics:
      job.default: default
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cordum-timeouts
  namespace: cordum
data:
  timeouts.yaml: |
    workflows: {}
    topics: {}
    reconciler:
      dispatch_timeout_seconds: 300
      running_timeout_seconds: 9000
      scan_interval_seconds: 30
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cordum-safety
  namespace: cordum
data:
  safety.yaml: |
    default_tenant: default
    tenants:
      default:
        allow_topics:
          - "job.*"
        deny_topics:
          - "sys.*"
        allowed_repo_hosts: []
        denied_repo_hosts: []
        mcp:
          allow_servers: []
          deny_servers: []
          allow_tools: []
          deny_tools: []
          allow_resources: []
          deny_resources: []
          allow_actions: []
          deny_actions: []
---
apiVersion: v1
kind: Secret
metadata:
  name: cordum-api-key
  namespace: cordum
type: Opaque
stringData:
  API_KEY: super-secret-key
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nats
  namespace: cordum
spec:
  replicas: 1
  selector:
    matchLabels: {app: nats}
  template:
    metadata:
      labels: {app: nats}
    spec:
      containers:
      - name: nats
        image: nats:2.10
        args: ["-js"]
        ports:
        - name: client
          containerPort: 4222
        livenessProbe:
          tcpSocket: {port: 4222}
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: nats
  namespace: cordum
spec:
  selector: {app: nats}
  ports:
  - name: client
    port: 4222
    targetPort: 4222
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: cordum
spec:
  replicas: 1
  selector:
    matchLabels: {app: redis}
  template:
    metadata:
      labels: {app: redis}
    spec:
      containers:
      - name: redis
        image: redis:7
        ports:
        - containerPort: 6379
        livenessProbe:
          tcpSocket: {port: 6379}
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: cordum
spec:
  selector: {app: redis}
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cordum-context-engine
  namespace: cordum
spec:
  replicas: 1
  selector:
    matchLabels: {app: cordum-context-engine}
  template:
    metadata:
      labels: {app: cordum-context-engine}
    spec:
      containers:
      - name: context-engine
        image: cordum-context-engine
        env:
        - name: REDIS_URL
          value: redis://redis:6379
        - name: CONTEXT_ENGINE_ADDR
          value: :50070
        ports:
        - containerPort: 50070
---
apiVersion: v1
kind: Service
metadata:
  name: cordum-context-engine
  namespace: cordum
spec:
  selector: {app: cordum-context-engine}
  ports:
  - name: grpc
    port: 50070
    targetPort: 50070
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cordum-safety-kernel
  namespace: cordum
spec:
  replicas: 1
  selector:
    matchLabels: {app: cordum-safety-kernel}
  template:
    metadata:
      labels: {app: cordum-safety-kernel}
    spec:
      containers:
      - name: safety
        image: cordum-safety-kernel
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: SAFETY_KERNEL_ADDR
          value: :50051
        - name: SAFETY_POLICY_PATH
          value: /etc/cordum/safety.yaml
        volumeMounts:
        - name: cordum-safety
          mountPath: /etc/cordum
          readOnly: true
        ports:
        - containerPort: 50051
      volumes:
      - name: cordum-safety
        configMap:
          name: cordum-safety
---
apiVersion: v1
kind: Service
metadata:
  name: cordum-safety-kernel
  namespace: cordum
spec:
  selector: {app: cordum-safety-kernel}
  ports:
  - name: grpc
    port: 50051
    targetPort: 50051
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cordum-scheduler
  namespace: cordum
spec:
  replicas: 1
  selector:
    matchLabels: {app: cordum-scheduler}
  template:
    metadata:
      labels: {app: cordum-scheduler}
    spec:
      containers:
      - name: scheduler
        image: cordum-scheduler
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: NATS_USE_JETSTREAM
          value: "1"
        - name: REDIS_URL
          value: redis://redis:6379
        - name: SAFETY_KERNEL_ADDR
          value: cordum-safety-kernel:50051
        - name: POOL_CONFIG_PATH
          value: /etc/cordum/pools.yaml
        - name: TIMEOUT_CONFIG_PATH
          value: /etc/cordum/timeouts.yaml
        volumeMounts:
        - name: cordum-pools
          mountPath: /etc/cordum/pools.yaml
          subPath: pools.yaml
          readOnly: true
        - name: cordum-timeouts
          mountPath: /etc/cordum/timeouts.yaml
          subPath: timeouts.yaml
          readOnly: true
        ports:
        - containerPort: 9090
      volumes:
      - name: cordum-pools
        configMap:
          name: cordum-pools
      - name: cordum-timeouts
        configMap:
          name: cordum-timeouts
---
apiVersion: v1
kind: Service
metadata:
  name: cordum-scheduler
  namespace: cordum
spec:
  selector: {app: cordum-scheduler}
  ports:
  - name: metrics
    port: 9090
    targetPort: 9090
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cordum-api-gateway
  namespace: cordum
spec:
  replicas: 1
  selector:
    matchLabels: {app: cordum-api-gateway}
  template:
    metadata:
      labels: {app: cordum-api-gateway}
    spec:
      containers:
      - name: gateway
        image: cordum-api-gateway
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: NATS_USE_JETSTREAM
          value: "1"
        - name: REDIS_URL
          value: redis://redis:6379
        - name: SAFETY_KERNEL_ADDR
          value: cordum-safety-kernel:50051
        - name: TENANT_ID
          value: default
        - name: API_RATE_LIMIT_RPS
          value: "50"
        - name: API_RATE_LIMIT_BURST
          value: "100"
        - name: REDIS_DATA_TTL
          value: 24h
        - name: JOB_META_TTL
          value: 168h
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: cordum-api-key
              key: API_KEY
        - name: CORDUM_API_KEY
          valueFrom:
            secretKeyRef:
              name: cordum-api-key
              key: API_KEY
        - name: CORDUM_SUPER_SECRET_API_TOKEN
          valueFrom:
            secretKeyRef:
              name: cordum-api-key
              key: API_KEY
        ports:
        - containerPort: 8080
        - containerPort: 8081
        - containerPort: 9092
---
apiVersion: v1
kind: Service
metadata:
  name: cordum-api-gateway
  namespace: cordum
spec:
  selector: {app: cordum-api-gateway}
  ports:
  - name: grpc
    port: 8080
    targetPort: 8080
  - name: http
    port: 8081
    targetPort: 8081
  - name: metrics
    port: 9092
    targetPort: 9092
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cordum-workflow-engine
  namespace: cordum
spec:
  replicas: 1
  selector:
    matchLabels: {app: cordum-workflow-engine}
  template:
    metadata:
      labels: {app: cordum-workflow-engine}
    spec:
      containers:
      - name: workflow-engine
        image: cordum-workflow-engine
        env:
        - name: NATS_URL
          value: nats://nats:4222
        - name: NATS_USE_JETSTREAM
          value: "1"
        - name: REDIS_URL
          value: redis://redis:6379
        - name: WORKFLOW_ENGINE_HTTP_ADDR
          value: :9093
        - name: WORKFLOW_ENGINE_SCAN_INTERVAL
          value: 5s
        - name: WORKFLOW_ENGINE_RUN_SCAN_LIMIT
          value: "200"
        ports:
        - containerPort: 9093
---
apiVersion: v1
kind: Service
metadata:
  name: cordum-workflow-engine
  namespace: cordum
spec:
  selector: {app: cordum-workflow-engine}
  ports:
  - name: http
    port: 9093
    targetPort: 9093
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cordum-dashboard
  namespace: cordum
spec:
  replicas: 1
  selector:
    matchLabels: {app: cordum-dashboard}
  template:
    metadata:
      labels: {app: cordum-dashboard}
    spec:
      containers:
      - name: dashboard
        image: cordum-dashboard
        env:
        - name: CORDUM_API_KEY
          valueFrom:
            secretKeyRef:
              name: cordum-api-key
              key: API_KEY
        - name: CORDUM_TENANT_ID
          value: default
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: cordum-dashboard
  namespace: cordum
spec:
  selector: {app: cordum-dashboard}
  ports:
  - name: http
    port: 8080
    targetPort: 8080
